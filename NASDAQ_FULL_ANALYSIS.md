# 那斯達克全部股票相關性分析功能

## 功能說明

此功能可以分析所有那斯達克股票（約4000支）與那斯達克綜合指數（^IXIC）的相關性，幫助投資人找出與指數走勢最相關的股票。

## 主要特點

### 1. 全市場分析

- 自動從 NASDAQ 官方 FTP 下載所有股票列表
- 支援約 4000+ 支股票的批次分析
- 備用股票列表確保可用性

### 2. 彈性參數設置

- **起始日期/結束日期**：自定義分析時間範圍
- **最小相關係數**：過濾低相關性股票（預設 0.5）
- **顯示數量**：選擇返回的結果數量（50/100/200/500/1000）

### 3. 高效能處理

- 使用 ThreadPoolExecutor 並行下載（最多20個工作線程）
- Redis 緩存策略：
  - 股票列表：7天
  - 個股數據：1小時
  - 相關性結果：1小時
- 自動過濾無效數據（少於50個交易日的股票）

### 4. 豐富的數據展示

- **統計摘要**：
  - 平均相關性
  - 最高相關性
  - 最低相關性
  - 數據點數量
- **排名列表**：
  - 依相關係數絕對值排序
  - 顯示股票代碼、公司名稱
  - 相關係數、P值、數據點數
  - 視覺化進度條

### 5. 實用工具

- **搜索功能**：即時搜索股票代碼或公司名稱
- **CSV 匯出**：一鍵匯出分析結果
- **進度顯示**：即時顯示分析進度

## API 端點

### 1. 獲取全部相關性分析

```
GET /api/nasdaq/all-correlation
```

**參數**：

- `start_date` (選填): 起始日期，格式 YYYY-MM-DD，預設 2020-01-01
- `end_date` (選填): 結束日期，格式 YYYY-MM-DD，預設今天
- `min_correlation` (選填): 最小相關係數，0-1之間，預設 0.5
- `limit` (選填): 返回結果數量，預設 100

**回應範例**：

```json
{
  "total_analyzed": 4000,
  "total_with_data": 3500,
  "filtered_count": 1200,
  "returned_count": 100,
  "correlations": [
    {
      "symbol": "AAPL",
      "name": "Apple Inc.",
      "correlation": 0.9234,
      "p_value": 0.000001,
      "data_points": 1250
    },
    ...
  ],
  "index": {
    "symbol": "^IXIC",
    "name": "NASDAQ Composite",
    "data_points": 1260
  }
}
```

### 2. 獲取股票列表

```
GET /api/nasdaq/tickers
```

**回應範例**：

```json
{
  "count": 4000,
  "tickers": ["AAPL", "MSFT", "GOOGL", ...]
}
```

## 使用方式

### 網頁界面

1. 開啟應用程式：http://localhost
2. 點擊頂部導航「那斯達克全部股票相關性」標籤
3. 設置分析參數：
   - 選擇日期範圍
   - 設定最小相關係數
   - 選擇顯示數量
4. 點擊「開始分析」按鈕
5. 等待分析完成（首次約需 10-30 分鐘，之後有緩存會很快）
6. 查看結果：
   - 查看統計摘要
   - 瀏覽排名列表
   - 使用搜索功能找特定股票
   - 匯出 CSV 進行進一步分析

### 命令列測試

```bash
# 測試獲取股票列表
curl http://localhost:8000/api/nasdaq/tickers

# 測試相關性分析（限制10筆以快速測試）
curl "http://localhost:8000/api/nasdaq/all-correlation?limit=10&min_correlation=0.7"
```

## 效能考量

### 首次執行

- 需要下載所有股票數據
- 預計時間：10-30 分鐘（取決於網絡速度和股票數量）
- 建議在非交易時段執行

### 後續執行

- 利用 Redis 緩存
- 相同參數的查詢幾乎即時返回
- 緩存過期後自動重新計算

### 資源使用

- 記憶體：建議 2GB 以上
- CPU：多核心處理器效能更佳
- 網絡：需要穩定的網絡連接下載數據

## 相關性解讀

### 相關係數範圍

- **0.8 - 1.0**：非常強的正相關（綠色顯示）
- **0.6 - 0.8**：強相關（藍色顯示）
- **0.4 - 0.6**：中度相關（橙色顯示）
- **0.0 - 0.4**：弱相關（灰色顯示）
- **負值**：負相關（與指數反向走勢）

### P值

- P值 < 0.05：相關性具有統計顯著性
- P值越小，相關性越可靠

### 數據點

- 數據點越多，相關性越可靠
- 系統自動過濾少於 50 個交易日的股票

## 注意事項

1. **首次使用**：第一次分析需要較長時間，請耐心等待
2. **緩存策略**：相關性結果緩存 1 小時，如需最新數據請等待緩存過期或清除緩存
3. **數據來源**：所有數據來自 Yahoo Finance，可能有延遲或錯誤
4. **分析限制**：
   - 只分析有足夠交易歷史的股票（至少100個交易日）
   - 需要至少50個共同交易日才能計算相關性
5. **投資建議**：相關性分析僅供參考，不構成投資建議

## 故障排除

### 分析失敗

- 檢查網絡連接
- 確認 Redis 服務正常運行
- 查看後端日誌：`docker-compose logs backend`

### 股票列表下載失敗

- 系統會自動使用備用股票列表
- 備用列表包含主要的 100+ 支股票

### 結果不完整

- 可能是部分股票數據下載失敗
- 系統會自動跳過失敗的股票
- 查看 `total_with_data` 了解成功下載的股票數量

## 未來優化方向

1. **進度追蹤**：更精確的進度顯示
2. **分組分析**：按產業、市值分組分析
3. **歷史追蹤**：追蹤相關性隨時間的變化
4. **背景任務**：使用 Celery 進行異步處理
5. **數據持久化**：將分析結果存儲到數據庫
6. **更多指標**：加入其他技術指標分析
