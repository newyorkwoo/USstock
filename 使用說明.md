# 本地持久化存儲使用說明

## 🎯 功能概述

系統已升級為本地持久化存儲方案：

- ✅ 將2010-01-01至今的所有那斯達克股票歷史資料存放在本地端
- ✅ 未來啟動時只需增量更新到當日最新股價
- ✅ 大幅減少啟動時間（從5-10分鐘減少到1-3分鐘）
- ✅ 數據持久化，容器重啟不丟失

## 📂 數據存儲位置

- Docker 卷名稱：`usstock-stock-data`
- 容器內路徑：`/app/data`
- 數據結構：
  ```
  /app/data/
  ├── stocks/          # 股票數據目錄
  │   ├── AAPL.json.gz
  │   ├── MSFT.json.gz
  │   └── ... (約3500個文件)
  └── meta.json        # 元數據文件
  ```

## 🚀 使用步驟

### 1. 首次初始化（一次性，約30-60分鐘）

```bash
cd /Users/steven/Documents/myproject/USstock

# 方法1：使用腳本（推薦）
./init-local-storage.sh

# 方法2：手動調用 API
curl -X POST http://localhost:8000/storage/download-all-to-local \
  -H "Content-Type: application/json" \
  -d '{"start_date": "2010-01-01"}' \
  --max-time 7200
```

**初始化期間：**

- 系統將下載約3500支那斯達克股票的歷史資料
- 數據範圍：2010-01-01 至今
- 預計時間：30-60 分鐘
- 下載成功率：約85-90%
- 存儲大小：約200-300MB（gzip壓縮）

### 2. 日常增量更新（快速，1-3分鐘）

每次重啟專案後，或需要更新最新數據時：

```bash
# 方法1：使用腳本（推薦）
./update-local-data.sh

# 方法2：手動調用 API
curl -X POST http://localhost:8000/storage/update-incremental \
  -H "Content-Type: application/json"
```

**增量更新特點：**

- 只下載自上次更新後的新交易日數據
- 預計時間：1-3 分鐘
- 自動檢測每支股票的最後日期
- 跳過已是最新的股票

### 3. 查看存儲統計

```bash
curl http://localhost:8000/storage/stats | python3 -m json.tool
```

輸出示例：

```json
{
  "total_stocks": 3521,
  "total_size_mb": 245.8,
  "data_directory": "/app/data/stocks",
  "start_date": "2010-01-01",
  "last_update": "2026-01-26 09:15:32",
  "last_full_download": "2026-01-26 08:45:12"
}
```

### 4. 載入特定股票數據

```bash
# 查看 Apple 的歷史數據
curl http://localhost:8000/storage/load/AAPL | python3 -m json.tool
```

## 📊 API 端點

| 端點                             | 方法 | 說明                     | 預計時間  |
| -------------------------------- | ---- | ------------------------ | --------- |
| `/storage/download-all-to-local` | POST | 完整下載所有股票         | 30-60分鐘 |
| `/storage/update-incremental`    | POST | 增量更新（只下載新數據） | 1-3分鐘   |
| `/storage/stats`                 | GET  | 查看存儲統計資訊         | <1秒      |
| `/storage/load/<symbol>`         | GET  | 載入特定股票數據         | <1秒      |

## ⚡ 性能對比

| 操作          | 舊方案（Redis緩存） | 新方案（本地存儲）  |
| ------------- | ------------------- | ------------------- |
| 首次啟動      | 5-10分鐘            | 30-60分鐘（一次性） |
| 重啟/每日啟動 | 5-10分鐘            | 1-3分鐘 ⚡          |
| 數據持久化    | ❌                  | ✅                  |
| 容器重啟後    | 需重新下載          | 只需增量更新        |

## 🔧 故障排除

### 權限問題

如果遇到權限錯誤，請確認容器已正確設置：

```bash
docker exec usstock-backend ls -la /app/data
# 應該看到 appuser:appuser 擁有權限
```

### 清除並重新初始化

```bash
# 停止容器
docker-compose down

# 刪除舊數據卷
docker volume rm usstock-stock-data

# 重新啟動
docker-compose up -d

# 重新初始化
./init-local-storage.sh
```

### 查看下載進度

```bash
# 查看後端日誌
docker-compose logs -f backend

# 或
docker logs -f usstock-backend
```

## 📝 注意事項

1. **首次初始化是一次性操作**：完成後無需再次執行，除非需要清空重建
2. **增量更新建議**：每天啟動時運行一次 `update-local-data.sh`
3. **數據備份**：Docker卷數據存放在主機，可以使用 `docker volume inspect usstock-stock-data` 查看位置
4. **網絡要求**：初始化期間需要穩定的網絡連接
5. **存儲空間**：預留至少500MB空間（實際約250MB，預留緩衝）

## 🎉 開始使用

```bash
# 1. 確保容器運行
docker-compose ps

# 2. 首次初始化（等待30-60分鐘）
./init-local-storage.sh

# 3. 查看統計（確認下載完成）
curl http://localhost:8000/storage/stats | python3 -m json.tool

# 4. 以後每天只需增量更新（1-3分鐘）
./update-local-data.sh
```

## 📖 更多資訊

詳細的技術文檔請參考：[LOCAL_STORAGE_GUIDE.md](LOCAL_STORAGE_GUIDE.md)
