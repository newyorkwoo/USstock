# 日期過濾功能使用說明

## 功能概述

新增的日期過濾功能允許用戶自定義 K線圖顯示的數據時間範圍，讓您能夠專注於特定時間段的市場走勢分析。

## 使用方法

### 1. 選擇日期範圍

在 K線圖右上角，您會看到兩個日期選擇器：

- **起始日期**: 選擇數據的開始時間
- **結束日期**: 選擇數據的結束時間

### 2. 套用過濾

選擇好日期後，點擊 **「套用」** 按鈕，系統會：

- 從後端獲取指定日期範圍的數據
- 更新 K線圖顯示
- 更新數據統計資訊（當前價格、漲跌幅、成交量）
- 顯示實際的數據範圍和筆數

### 3. 重置過濾

點擊 **「重置」** 按鈕可以快速恢復顯示全部數據（2010-01-01 至今）。

## 功能特點

### ✅ 靈活的日期選擇

- 支持任意日期範圍（最早可追溯至 2010 年）
- 自動驗證日期邏輯（結束日期不能早於起始日期）
- 結束日期最多到今天

### ✅ 智能緩存

- 不同的日期範圍會獨立緩存
- 重複查詢相同日期範圍可從緩存快速獲取
- 緩存時效 1 小時，確保數據時效性

### ✅ 實時反饋

- 顯示實際獲取的數據範圍
- 顯示數據筆數統計
- 加載狀態動畫提示

### ✅ 性能優化

- 後端支持日期參數查詢
- Redis 緩存加速重複請求
- 前端狀態管理避免重複請求

## 使用場景

### 1. 短期分析（最近幾個月）

```
起始日期: 2025-10-01
結束日期: 2026-01-26
```

適合分析最近的市場走勢和短期趨勢。

### 2. 年度回顧（查看特定年份）

```
起始日期: 2023-01-01
結束日期: 2024-01-01
```

查看 2023 年全年的市場表現（約 250 個交易日）。

### 3. 長期趨勢（多年分析）

```
起始日期: 2020-01-01
結束日期: 2026-01-26
```

分析跨越多年的長期市場趨勢。

### 4. 特定事件期間

選擇特定事件發生前後的日期，分析市場反應：

- 經濟政策發布
- 重大財報季
- 市場重大事件

## API 使用

### 後端 API

```bash
GET /api/index/:symbol?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD
```

**參數說明:**

- `symbol`: 指數代碼 (如 ^IXIC)
- `start_date`: 起始日期（可選，默認 2010-01-01）
- `end_date`: 結束日期（可選，默認今天）

**請求示例:**

```bash
# 查詢 2023 年數據
curl "http://localhost:8000/api/index/%5EIXIC?start_date=2023-01-01&end_date=2024-01-01"

# 查詢最近 6 個月
curl "http://localhost:8000/api/index/%5EIXIC?start_date=2025-07-01"

# 查詢全部數據（使用默認值）
curl "http://localhost:8000/api/index/%5EIXIC"
```

**響應格式:**

```json
{
  "symbol": "^IXIC",
  "name": "NASDAQ",
  "history": [
    {
      "date": "2023-01-03",
      "open": 10562.06,
      "high": 10613.06,
      "low": 10309.16,
      "close": 10386.98,
      "volume": 4780650000
    },
    ...
  ],
  "data_range": {
    "start": "2023-01-03",
    "end": "2023-12-29",
    "count": 250
  }
}
```

### 前端 API

```javascript
import { fetchIndexData } from "./utils/api";

// 獲取指定日期範圍的數據
const data = await fetchIndexData("^IXIC", "2023-01-01", "2024-01-01");
```

## 測試腳本

運行測試腳本驗證日期過濾功能：

```bash
./test_date_filter.sh
```

測試內容包括：

1. 查詢 2023 年全年數據
2. 查詢最近 6 個月數據
3. 查詢最近 1 年數據
4. 查詢全部數據

## 注意事項

### 1. 數據可用性

- Yahoo Finance 的歷史數據最早到 2010 年
- 週末和節假日沒有交易數據
- 實際返回的日期範圍可能略有差異（取決於交易日）

### 2. 性能考慮

- 查詢較長時間範圍（如全部 15 年數據）首次加載需要約 1-2 秒
- 使用緩存後，重複查詢僅需 0.003 秒
- 建議根據分析需求選擇合適的時間範圍

### 3. 相關性分析

- 相關性分析暫不支持日期過濾
- 始終使用全部歷史數據計算相關係數
- 確保相關性分析的統計顯著性

## 技術實現

### 前端實現

- Vue 3 Composition API
- 原生 HTML5 日期選擇器
- 響應式狀態管理

### 後端實現

- Flask 路由查詢參數
- yfinance 日期範圍查詢
- Redis 緩存（按日期範圍區分）

### 緩存策略

```python
# 緩存鍵格式
cache_key = f"download_stock_data:{symbol}:start_date:{start}:end_date:{end}"

# 緩存時效
CACHE_TTL_STOCK_DATA = 3600  # 1 小時
```

## 常見問題

### Q: 為什麼選擇的日期和實際顯示的日期不完全一致？

A: 因為股市只在交易日開盤，週末和節假日沒有數據。系統會返回選定範圍內的實際交易日數據。

### Q: 可以選擇未來的日期嗎？

A: 不可以。結束日期最多只能選到今天。

### Q: 日期過濾會影響相關性分析嗎？

A: 目前不會。相關性分析始終使用全部歷史數據，以確保統計結果的可靠性。

### Q: 如何快速查看最近一個月的數據？

A: 手動選擇起始日期為一個月前，或使用瀏覽器的日期選擇器快速選擇。

## 更新日誌

### v1.1.0 (2026-01-26)

- ✨ 新增日期範圍選擇功能
- ✨ 添加套用和重置按鈕
- 🚀 後端支持日期參數查詢
- 💾 緩存系統支持不同日期範圍
- 📝 添加測試腳本和文檔

## 反饋與建議

如有任何問題或建議，歡迎提交 Issue 或 Pull Request。
